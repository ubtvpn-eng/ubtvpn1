---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  
  // Extract unique categories from the first part of the slug
  // e.g. "reviews/article-1" -> "reviews"
  const categories = [...new Set(allPosts.map(post => {
      const parts = post.slug.split('/');
      return parts.length > 1 ? parts[0] : 'general';
  }))];

  return categories.map(category => {
    // Filter posts for this category
    const categoryPosts = allPosts.filter(post => {
        const parts = post.slug.split('/');
        const postCategory = parts.length > 1 ? parts[0] : 'general';
        return postCategory === category;
    });

    return {
      params: { category },
      props: { posts: categoryPosts, category },
    };
  });
}

const { category, posts } = Astro.props;
const categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
---

<Layout title={`${categoryTitle} | UBTVPN Blog`}>
  <section class="max-w-4xl mx-auto px-4 py-12">
    <header class="mb-12">
        <a href="/blog" class="text-slate-500 hover:text-white mb-4 inline-block">← Все статьи</a>
        <h1 class="text-4xl font-bold text-white mb-4">
            Категория: <span class="text-cyber-primary">{categoryTitle}</span>
        </h1>
    </header>
    
    <div class="space-y-8">
        {posts.map((post) => (
            <a href={`/blog/${post.slug}/`} class="block bg-slate-800 p-8 rounded-2xl border border-slate-700 hover:border-cyber-primary transition group">
                <div class="flex flex-col md:flex-row gap-6 justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-3 group-hover:text-cyber-primary transition">
                            {post.data.title}
                        </h2>
                        <p class="text-slate-400 mb-4 line-clamp-2">
                            {post.data.description}
                        </p>
                        <div class="flex gap-4 text-sm text-slate-500">
                            <span>{post.data.pubDate.toLocaleDateString('ru-RU')}</span>
                            {post.data.tags && <span>{post.data.tags.join(', ')}</span>}
                        </div>
                    </div>
                </div>
            </a>
        ))}
    </div>
  </section>
</Layout>
